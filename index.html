<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contractor Command Center</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex-1 flex flex-col relative overflow-hidden"></div>

    <script>
        // ==========================================
        // 1. DATABASE LAYER (IndexedDB - Offline Only)
        // ==========================================
        const DB_NAME = 'ContractorCommand_Final';
        const DB_VERSION = 1;
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id' });
                    
                    // Estimate Items
                    if (!db.objectStoreNames.contains('estimateItems')) {
                        const store = db.createObjectStore('estimateItems', { keyPath: 'id' });
                        store.createIndex('projectId', 'projectId', { unique: false });
                    }

                    // Photos
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { keyPath: 'id' });
                        store.createIndex('projectId', 'projectId', { unique: false });
                    }
                    
                    // Financials (Change Orders & Payments)
                    if (!db.objectStoreNames.contains('financials')) {
                        const store = db.createObjectStore('financials', { keyPath: 'id' });
                        store.createIndex('projectId', 'projectId', { unique: false });
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            });
        };

        const dbOp = (storeName, mode, callback) => {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, mode);
                const store = tx.objectStore(storeName);
                const req = callback(store);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };

        const getProjectData = (storeName, projectId) => {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const index = store.index('projectId');
                const req = index.getAll(projectId);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };

        // ==========================================
        // 2. STATE & UTILS
        // ==========================================
        const state = {
            view: 'dashboard', 
            activeProject: null,
            activeTab: 'estimate', 
            projects: [],
            estimateItems: [],
            photos: [],
            financials: []
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const currency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num || 0);
        const formatDate = (iso) => new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

        // ==========================================
        // 3. BACKUP & RESTORE
        // ==========================================
        const exportProject = async () => {
            if(!state.activeProject) return;
            try {
                const zip = new JSZip();
                
                // Add all data types
                zip.file("project_info.json", JSON.stringify(state.activeProject, null, 2));
                zip.file("estimate_data.json", JSON.stringify(state.estimateItems, null, 2));
                zip.file("photos_data.json", JSON.stringify(state.photos, null, 2));
                zip.file("financials_data.json", JSON.stringify(state.financials, null, 2));

                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                const safeName = state.activeProject.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.download = `${safeName}_full_backup.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } catch (err) { alert("Backup failed: " + err.message); }
        };

        const importProject = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.zip';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const zip = new JSZip();
                    const content = await zip.loadAsync(file);
                    
                    // Read Project Info
                    const pInfoStr = await content.file("project_info.json").async("string");
                    const project = JSON.parse(pInfoStr);
                    
                    // Create new ID to avoid collisions, or overwrite? Let's Create New.
                    const oldId = project.id;
                    const newId = generateId();
                    project.id = newId;
                    project.name = project.name + " (Restored)";
                    
                    await dbOp('projects', 'readwrite', s => s.put(project));

                    // Helper to import arrays
                    const importArray = async (filename, storeName) => {
                        const file = content.file(filename);
                        if(file) {
                            const str = await file.async("string");
                            const arr = JSON.parse(str);
                            for(let item of arr) {
                                item.id = generateId(); // New IDs
                                item.projectId = newId; // Link to new project
                                await dbOp(storeName, 'readwrite', s => s.put(item));
                            }
                        }
                    };

                    await importArray("estimate_data.json", "estimateItems");
                    await importArray("photos_data.json", "photos");
                    await importArray("financials_data.json", "financials");

                    await loadProjects();
                    alert("Project Restored Successfully!");
                } catch (err) {
                    alert("Import Failed: " + err.message);
                }
            };
            input.click();
        };

        // ==========================================
        // 4. UI RENDERERS
        // ==========================================
        
        // --- DASHBOARD ---
        const renderDashboard = () => {
            const projectListHtml = state.projects.length ? state.projects.map(p => `
                <div onclick="loadProject('${p.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 active:scale-95 transition-transform cursor-pointer">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">${p.name}</h3>
                            <p class="text-sm text-slate-500">${p.clientName || 'No Client'}</p>
                        </div>
                        <span class="text-xs bg-blue-50 text-blue-600 border border-blue-100 px-2 py-1 rounded-full">${new Date(p.updatedAt).toLocaleDateString()}</span>
                    </div>
                    <div class="mt-3 flex justify-between items-end border-t pt-2">
                        <div class="text-xs text-gray-400">STATUS: ${p.status || 'Active'}</div>
                        <div class="font-bold text-blue-600 text-sm">Open Project &rarr;</div>
                    </div>
                </div>
            `).join('') : `<div class="text-center p-10 text-gray-400 col-span-full">No projects found.</div>`;

            return `
                <header class="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-20 shadow-sm">
                    <h1 class="text-xl font-black text-blue-700 tracking-tight">CONTRACTOR<span class="text-slate-800">HUB</span></h1>
                    <div class="flex gap-2">
                        <button onclick="importProject()" class="text-sm text-slate-600 font-medium px-3 py-2 bg-slate-100 rounded-lg">Import</button>
                        <button onclick="showModal('newProject')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 transition">+ New</button>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto p-4 bg-slate-50">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${projectListHtml}
                    </div>
                </main>
            `;
        };

        // --- PROJECT CONTAINER ---
        const renderProjectView = () => {
            if(!state.activeProject) return '';
            
            return `
                <div class="flex flex-col h-full bg-slate-50">
                    <header class="bg-white border-b shadow-sm z-20">
                        <div class="flex items-center p-3 gap-3">
                            <button onclick="setView('dashboard')" class="p-2 rounded-full hover:bg-slate-100 text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <div class="flex-1 overflow-hidden">
                                <h2 class="font-bold text-lg truncate text-slate-800">${state.activeProject.name}</h2>
                                <p class="text-xs text-slate-500 truncate">${state.activeProject.address || 'No Address'}</p>
                            </div>
                            <button onclick="exportProject()" class="flex items-center gap-1 text-blue-600 font-medium text-sm bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Backup
                            </button>
                        </div>
                        <div class="flex text-sm font-medium border-t">
                            <button onclick="setTab('estimate')" class="flex-1 py-3 text-center transition-colors ${state.activeTab === 'estimate' ? 'tab-active' : 'tab-inactive'}">Estimate</button>
                            <button onclick="setTab('photos')" class="flex-1 py-3 text-center transition-colors ${state.activeTab === 'photos' ? 'tab-active' : 'tab-inactive'}">Photos</button>
                            <button onclick="setTab('financials')" class="flex-1 py-3 text-center transition-colors ${state.activeTab === 'financials' ? 'tab-active' : 'tab-inactive'}">Billing</button>
                        </div>
                    </header>

                    <main id="project-content" class="flex-1 overflow-y-auto">
                        ${renderTabContent()}
                    </main>
                </div>
            `;
        };

        const renderTabContent = () => {
            switch(state.activeTab) {
                case 'estimate': return renderEstimateTab();
                case 'photos': return renderPhotosTab();
                case 'financials': return renderFinancialsTab();
                default: return '';
            }
        };

        // --- ESTIMATE TAB ---
        const renderEstimateTab = () => {
            const phases = {};
            let totalMat = 0, totalLab = 0;

            state.estimateItems.forEach(item => {
                if(!phases[item.phase]) phases[item.phase] = {};
                if(!phases[item.phase][item.task]) phases[item.phase][item.task] = [];
                phases[item.phase][item.task].push(item);
                const cost = (parseFloat(item.quantity)||0) * (parseFloat(item.unitCost)||0);
                if(item.type === 'Material') totalMat += cost; else totalLab += cost;
            });

            const m = state.activeProject.markups || { overhead: 0, profit: 0, tax: 0 };
            const subtotal = totalMat + totalLab;
            const overheadAmt = subtotal * (m.overhead / 100);
            const profitAmt = (subtotal + overheadAmt) * (m.profit / 100);
            const taxAmt = (subtotal + overheadAmt + profitAmt) * (m.tax / 100);
            const finalTotal = subtotal + overheadAmt + profitAmt + taxAmt;

            let phasesHtml = Object.keys(phases).map(phase => {
                let tasksHtml = Object.keys(phases[phase]).map(task => {
                    const items = phases[phase][task];
                    const taskTotal = items.reduce((sum, i) => sum + ((i.quantity||0)*(i.unitCost||0)), 0);
                    const itemsHtml = items.map(i => `
                        <div class="grid grid-cols-12 gap-2 text-sm py-2 border-b border-gray-100 items-center bg-white pl-4">
                            <div class="col-span-5 font-medium text-slate-700 truncate">${i.description || 'Item'}</div>
                            <div class="col-span-2 text-right text-gray-500 text-xs">${i.quantity}</div>
                            <div class="col-span-2 text-right text-gray-500 text-xs">$${i.unitCost}</div>
                            <div class="col-span-2 text-right font-semibold text-xs">${currency(i.quantity * i.unitCost)}</div>
                            <div class="col-span-1 text-right"><button onclick="deleteItem('${i.id}')" class="text-red-400 hover:text-red-600 font-bold px-2">×</button></div>
                        </div>
                    `).join('');
                    return `
                        <div class="mb-2">
                            <div class="bg-gray-100 p-2 px-3 rounded text-sm font-semibold text-slate-700 flex justify-between">
                                <span>${task}</span><span>${currency(taskTotal)}</span>
                            </div>
                            <div class="border-l-2 border-gray-200 ml-2">
                                ${itemsHtml}
                                <button onclick="showAddItemModal('${phase}', '${task}')" class="text-xs text-blue-600 font-bold py-2 pl-4 hover:underline">+ Add Item</button>
                            </div>
                        </div>
                    `;
                }).join('');
                return `
                    <div class="bg-white mb-4 rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-slate-50 p-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">${phase}</h3>
                            <button onclick="showAddItemModal('${phase}')" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded text-slate-600">+ Task</button>
                        </div>
                        <div class="p-3">${tasksHtml}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="p-4 pb-24">
                    <div class="bg-slate-800 text-white rounded-xl p-4 mb-6 shadow-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4 border-b border-slate-700 pb-4">
                            <div><div class="text-slate-400">Materials</div><div class="font-mono text-lg">${currency(totalMat)}</div></div>
                            <div><div class="text-slate-400">Labor</div><div class="font-mono text-lg">${currency(totalLab)}</div></div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="text-slate-400 text-sm">Bid Price</div>
                            <div class="font-bold text-3xl tracking-tight">${currency(finalTotal)}</div>
                        </div>
                    </div>
                    ${phasesHtml}
                    <button onclick="showAddPhaseModal()" class="w-full py-3 bg-white border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-semibold hover:border-blue-400 hover:text-blue-600 transition mb-8">+ Add New Phase</button>
                </div>
            `;
        };

        // --- PHOTOS TAB ---
        const renderPhotosTab = () => {
            // Group by date
            const grouped = {};
            state.photos.forEach(p => {
                const d = formatDate(p.date);
                if(!grouped[d]) grouped[d] = [];
                grouped[d].push(p);
            });

            const html = Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)).map(date => `
                <div class="mb-6">
                    <h3 class="font-bold text-slate-500 mb-2 ml-1 text-sm uppercase tracking-wide">${date}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        ${grouped[date].map(p => `
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden relative group">
                                <img src="${p.image}" class="w-full h-32 object-cover" />
                                <div class="p-2">
                                    <p class="font-bold text-xs truncate">${p.title || 'Untitled'}</p>
                                    <p class="text-xs text-gray-500 truncate">${p.notes || ''}</p>
                                </div>
                                <button onclick="deletePhoto('${p.id}')" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-md">×</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            return `
                <div class="p-4 pb-24">
                    ${state.photos.length === 0 ? '<div class="text-center p-10 text-gray-400">No photos yet.<br>Snap some progress!</div>' : html}
                    <div class="fixed bottom-6 right-6">
                         <label class="bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg cursor-pointer hover:bg-blue-700 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="addPhoto(this)">
                         </label>
                    </div>
                </div>
            `;
        };

        // --- FINANCIALS TAB ---
        const renderFinancialsTab = () => {
            const cos = state.financials.filter(f => f.type === 'change_order');
            const payments = state.financials.filter(f => f.type === 'payment');
            
            const totalCO = cos.reduce((s,i)=>s+parseFloat(i.amount),0);
            const totalPaid = payments.reduce((s,i)=>s+parseFloat(i.amount),0);
            
            // Calculate Base Bid (from Estimate Tab logic)
            // Note: For speed, we aren't recalculating the full estimate markup here, 
            // but in a real app you'd store the "Sold Price" somewhere fixed. 
            // For now, we will sum the current estimate items + markup.
            let estTotal = 0;
            state.estimateItems.forEach(i => estTotal += (i.quantity*i.unitCost));
            const m = state.activeProject.markups || {overhead:0, profit:0, tax:0};
            // Simplistic rollup for display
            const baseBid = estTotal * (1 + m.overhead/100) * (1 + m.profit/100) * (1 + m.tax/100);
            
            const grandTotal = baseBid + totalCO;
            const balance = grandTotal - totalPaid;

            return `
                <div class="p-4 pb-24">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                        <div class="flex justify-between py-1 text-sm text-gray-500"><span>Original Contract</span><span>${currency(baseBid)}</span></div>
                        <div class="flex justify-between py-1 text-sm text-gray-500"><span>Change Orders</span><span>+${currency(totalCO)}</span></div>
                        <div class="flex justify-between py-2 text-lg font-bold text-slate-800 border-t border-gray-100 mt-2"><span>Project Total</span><span>${currency(grandTotal)}</span></div>
                        <div class="flex justify-between py-1 text-sm text-green-600"><span>Paid to Date</span><span>-${currency(totalPaid)}</span></div>
                        <div class="flex justify-between py-3 mt-2 bg-slate-50 rounded-lg px-3 border border-slate-100">
                            <span class="font-bold text-slate-700">BALANCE DUE</span>
                            <span class="font-bold ${balance > 0 ? 'text-red-600' : 'text-green-600'} text-xl">${currency(balance)}</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700">Change Orders</h3>
                            <button onclick="addFinancial('change_order')" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">+ Add CO</button>
                        </div>
                        ${cos.length ? cos.map(i => `
                            <div class="bg-white p-3 rounded-lg border border-gray-200 mb-2 flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-sm text-slate-800">${i.description}</div>
                                    <div class="text-xs text-gray-400">${formatDate(i.date)}</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="font-mono font-bold text-slate-700">${currency(i.amount)}</div>
                                    <button onclick="deleteFinancial('${i.id}')" class="text-red-300 hover:text-red-600">×</button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-400 text-sm italic">No change orders.</div>'}
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700">Payments</h3>
                            <button onclick="addFinancial('payment')" class="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">+ Add Payment</button>
                        </div>
                        ${payments.length ? payments.map(i => `
                            <div class="bg-white p-3 rounded-lg border border-gray-200 mb-2 flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-sm text-slate-800">${i.description}</div>
                                    <div class="text-xs text-gray-400">${formatDate(i.date)}</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="font-mono font-bold text-green-600">-${currency(i.amount)}</div>
                                    <button onclick="deleteFinancial('${i.id}')" class="text-red-300 hover:text-red-600">×</button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-400 text-sm italic">No payments recorded.</div>'}
                    </div>
                </div>
            `;
        };

        // ==========================================
        // 5. CONTROLLER & ACTIONS
        // ==========================================
        const render = () => {
            const app = document.getElementById('app');
            if (state.view === 'dashboard') app.innerHTML = renderDashboard();
            else app.innerHTML = renderProjectView();
        };
        const setView = (v) => { state.view = v; if(v==='dashboard') state.activeProject=null; render(); };
        const setTab = (t) => { state.activeTab = t; render(); };

        const loadProject = async (id) => {
            state.activeProject = await dbOp('projects', 'readonly', s=>s.get(id));
            state.estimateItems = await getProjectData('estimateItems', id);
            state.photos = await getProjectData('photos', id);
            state.financials = await getProjectData('financials', id);
            state.view = 'project'; state.activeTab = 'estimate';
            render();
        };

        const loadProjects = async () => {
            state.projects = await dbOp('projects', 'readonly', s=>s.getAll());
            render();
        };

        // --- DATA MUTATIONS ---
        const createProject = async (name) => {
            const p = {
                id: generateId(), name: name, clientName: '', address: '', 
                createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
                status: 'Estimating', markups: { overhead: 10, profit: 20, tax: 0 }
            };
            await dbOp('projects', 'readwrite', s=>s.put(p));
            loadProjects();
        };

        const addItem = async (phase, task, desc, type, qty, cost) => {
            const item = { id: generateId(), projectId: state.activeProject.id, phase, task, description: desc, type, quantity: parseFloat(qty), unitCost: parseFloat(cost) };
            await dbOp('estimateItems', 'readwrite', s=>s.put(item));
            state.estimateItems = await getProjectData('estimateItems', state.activeProject.id);
            render();
        };

        const addPhoto = async (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const desc = prompt("Photo Description:");
                    const photo = {
                        id: generateId(), projectId: state.activeProject.id, 
                        image: e.target.result, title: desc || 'Job Photo', 
                        date: new Date().toISOString()
                    };
                    await dbOp('photos', 'readwrite', s=>s.put(photo));
                    state.photos = await getProjectData('photos', state.activeProject.id);
                    render();
                };
                reader.readAsDataURL(file);
            }
        };

        const addFinancial = async (type) => {
            const desc = prompt(type === 'change_order' ? "Description of Work:" : "Payment Method/Ref:");
            if(!desc) return;
            const amt = prompt("Amount ($):");
            if(!amt) return;
            const item = {
                id: generateId(), projectId: state.activeProject.id,
                type: type, description: desc, amount: parseFloat(amt),
                date: new Date().toISOString()
            };
            await dbOp('financials', 'readwrite', s=>s.put(item));
            state.financials = await getProjectData('financials', state.activeProject.id);
            render();
        };

        const deleteItem = async (id) => { if(confirm('Delete?')) { await dbOp('estimateItems', 'readwrite', s=>s.delete(id)); state.estimateItems = await getProjectData('estimateItems', state.activeProject.id); render(); }};
        const deletePhoto = async (id) => { if(confirm('Delete?')) { await dbOp('photos', 'readwrite', s=>s.delete(id)); state.photos = await getProjectData('photos', state.activeProject.id); render(); }};
        const deleteFinancial = async (id) => { if(confirm('Delete?')) { await dbOp('financials', 'readwrite', s=>s.delete(id)); state.financials = await getProjectData('financials', state.activeProject.id); render(); }};

        // --- MODALS ---
        const showModal = (t) => { if(t==='newProject') { const n=prompt("Project Name:"); if(n) createProject(n); }};
        const showAddPhaseModal = () => { const n=prompt("Phase Name:"); if(n) { const t=prompt(`First task for ${n}:`); if(t) showAddItemModal(n,t); }};
        const showAddItemModal = (p,t) => {
            if(!t) t=prompt(`Task for ${p}:`); if(!t) return;
            const d=prompt(`Item Description:`); if(!d) return;
            const c=prompt("Unit Cost ($):", "0"); const q=prompt("Quantity:", "1");
            const type=confirm("Material? (OK) or Labor? (Cancel)")?"Material":"Labor";
            addItem(p,t,d,type,q,c);
        };

        // START
        const init = async () => { try { await initDB(); await loadProjects(); } catch(e) { console.error(e); }};
        init();
    </script>
</body>
</html>
